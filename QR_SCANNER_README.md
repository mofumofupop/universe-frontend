# QRコードスキャナー機能

## 概要

このプロジェクトには、QRコードをスキャンして名刺交換を行う機能が実装されています。

## 実装ファイル

### コンポーネント

- **`src/components/QRScanner.tsx`**
  - QRコードスキャナーのUIコンポーネント
  - プライマリカメラ（背面カメラ）を自動選択
  - `html5-qrcode` ライブラリを使用

### ページ

- **`src/app/scanner/page.tsx`**
  - QRスキャナーページ
  - QRコード読み取り後のAPI呼び出し処理を含む
  - ローカルストレージからユーザー認証情報を取得

### API関数

- **`src/lib/api.ts`**
  - `exchangeBusinessCard()`: QRコードを使って名刺交換
  - `generateQRCode()`: QRコードを生成（将来的な実装用）
  - `getAuthFromStorage()`: ローカルストレージから認証情報を取得
  - `saveAuthToStorage()`: ローカルストレージに認証情報を保存
  - `clearAuthFromStorage()`: 認証情報を削除

### 型定義

- **`src/types/QRcode.ts`**
  - QRコード関連のTypeScript型定義

## 使用方法

### 1. 環境設定

`.env.local` ファイルを作成し、APIのベースURLを設定します：

```bash
NEXT_PUBLIC_API_BASE_URL=http://localhost:3001
```

### 2. スキャナーページへのアクセス

ブラウザで `/scanner` にアクセスします。

### 3. QRコードのスキャン

1. カメラへのアクセスを許可
2. 「スキャン開始」ボタンをクリック
3. QRコードをカメラに向ける
4. 自動的に読み取りが行われ、APIが呼び出されます

## API仕様

### 名刺交換API

**エンドポイント**: `POST /api/exchange`

**リクエストボディ**:
```json
{
  "id": "ユーザーのUUID",
  "password_hash": "SHA-256でハッシュ化されたパスワード",
  "qr": "QRコードから読み取った文字列"
}
```

**レスポンス** (成功時):
```json
{
  "success": true,
  "message": "名刺を交換しました",
  "id": "自分のUUID",
  "username": "自分のユーザー名",
  "new": {
    "id": "相手のUUID",
    "username": "相手のユーザー名"
  }
}
```

## 技術スタック

- **Next.js 15**: Reactフレームワーク
- **html5-qrcode**: QRコードスキャンライブラリ
- **TypeScript**: 型安全性
- **Tailwind CSS**: スタイリング
- **Radix UI**: UIコンポーネント

## カメラ選択ロジック

QRスキャナーは以下の優先順位でカメラを選択します：

1. ラベルに "back", "rear", "環境" を含むカメラ（背面カメラ）
2. 上記が見つからない場合、最初に利用可能なカメラ

## エラーハンドリング

- カメラへのアクセスが拒否された場合
- QRコードの読み取りに失敗した場合
- API呼び出しに失敗した場合
- ユーザーが未ログインの場合（ログインページへリダイレクト）

## セキュリティ

- ユーザーのUUIDとパスワードハッシュはローカルストレージに保存
- パスワードは必ずSHA-256でハッシュ化されたものを使用
- APIエンドポイントは環境変数で管理

## 今後の拡張

- QRコード生成機能の実装
- スキャン履歴の保存
- オフラインモードのサポート
- より高度なエラーハンドリング
